<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MTA Train Times - Prospect Park</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      min-height: 100vh;
      background-color: #fafafa;
      padding: 32px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card {
      width: 100%;
      max-width: 500px;
      background-color: #fff;
      border-radius: 24px;
      padding: 32px 48px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .section-header {
      font-size: 20px;
      font-weight: 600;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 3px;
      padding: 16px 0 12px 0;
    }

    .divider {
      height: 2px;
      background-color: #e5e5e5;
      margin: 8px 0;
    }

    .train-row {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 14px 0;
    }

    .line-circle {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      font-weight: bold;
      color: #fff;
      flex-shrink: 0;
    }

    .line-circle.B { background-color: #FF6319; }
    .line-circle.Q { background-color: #FCCC0A; color: #000; }
    .line-circle.S { background-color: #808183; }

    .times {
      display: flex;
      align-items: baseline;
      gap: 24px;
      font-size: 32px;
      font-weight: 500;
      color: #333;
    }

    .time-item {
      min-width: 50px;
    }

    .time-unit {
      color: #888;
      font-weight: 400;
      font-size: 20px;
    }

    .updated {
      margin-top: 32px;
      text-align: center;
      font-size: 14px;
      color: #aaa;
      letter-spacing: 1px;
    }
  </style>
</head>
<body>
  <div class="card">
    <!-- Manhattan Section -->
    <div class="section-header">Manhattan</div>
    <div class="train-row">
      <div class="line-circle B">B</div>
      <div class="times" id="manhattan-b"></div>
    </div>
    <div class="train-row">
      <div class="line-circle Q">Q</div>
      <div class="times" id="manhattan-q"></div>
    </div>

    <div class="divider"></div>

    <!-- Brooklyn Section -->
    <div class="section-header">Brooklyn</div>
    <div class="train-row">
      <div class="line-circle B">B</div>
      <div class="times" id="brooklyn-b"></div>
    </div>
    <div class="train-row">
      <div class="line-circle Q">Q</div>
      <div class="times" id="brooklyn-q"></div>
    </div>

    <div class="divider"></div>

    <!-- Franklin Ave Section -->
    <div class="section-header">Franklin Ave</div>
    <div class="train-row">
      <div class="line-circle S">S</div>
      <div class="times" id="franklin-s"></div>
    </div>

    <!-- Last Updated -->
    <div class="updated" id="updated"></div>
  </div>

  <script>
    const API_URL = 'http://localhost:8000/arrivals';

    // Transform API response to display format
    function transformData(apiData) {
      const result = {
        manhattan: { B: [], Q: [] },
        brooklyn: { B: [], Q: [] },
        franklin: { S: [] }
      };

      // Northbound = Manhattan (B, Q) and Franklin Ave (S)
      for (const arr of apiData.northbound || []) {
        if (arr.route === 'B') result.manhattan.B.push(arr.minutes_away);
        else if (arr.route === 'Q') result.manhattan.Q.push(arr.minutes_away);
        else if (arr.route === 'S') result.franklin.S.push(arr.minutes_away);
      }

      // Southbound = Brooklyn (B, Q)
      for (const arr of apiData.southbound || []) {
        if (arr.route === 'B') result.brooklyn.B.push(arr.minutes_away);
        else if (arr.route === 'Q') result.brooklyn.Q.push(arr.minutes_away);
      }

      return result;
    }

    // Render times into a container element, hide row if no trains
    function renderTimes(elementId, times) {
      const container = document.getElementById(elementId);
      const row = container.closest('.train-row');

      if (times.length === 0) {
        row.style.display = 'none';
        return;
      }

      row.style.display = 'flex';
      container.innerHTML = times
        .slice(0, 3)
        .map(t => `<span class="time-item">${t} <span class="time-unit">min</span></span>`)
        .join('');
    }

    // Update the last updated timestamp
    function updateTimestamp() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
      document.getElementById('updated').textContent = `Updated ${timeStr}`;
    }

    // Main update function
    async function updateDisplay() {
      try {
        const response = await fetch(API_URL);
        if (!response.ok) throw new Error('API error');
        const apiData = await response.json();
        const data = transformData(apiData);

        renderTimes('manhattan-b', data.manhattan.B);
        renderTimes('manhattan-q', data.manhattan.Q);
        renderTimes('brooklyn-b', data.brooklyn.B);
        renderTimes('brooklyn-q', data.brooklyn.Q);
        renderTimes('franklin-s', data.franklin.S);

        updateTimestamp();
      } catch (error) {
        console.error('Failed to fetch:', error);
        document.getElementById('updated').textContent = 'Connection error';
      }
    }

    // Initial load
    updateDisplay();

    // Refresh every 30 seconds
    setInterval(updateDisplay, 30000);

    // Refresh when page becomes visible (iPad wake)
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') updateDisplay();
    });
  </script>
</body>
</html>
