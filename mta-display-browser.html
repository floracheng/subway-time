<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MTA Train Times - Prospect Park</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      min-height: 100vh;
      background-color: #fafafa;
      padding: 32px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card {
      width: 100%;
      max-width: 500px;
      background-color: #fff;
      border-radius: 24px;
      padding: 32px 48px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .section-header {
      font-size: 20px;
      font-weight: 600;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 3px;
      padding: 16px 0 12px 0;
    }

    .divider {
      height: 2px;
      background-color: #e5e5e5;
      margin: 8px 0;
    }

    .train-row {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 14px 0;
    }

    .line-circle {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      font-weight: bold;
      color: #fff;
      flex-shrink: 0;
    }

    .line-circle.B { background-color: #FF6319; }
    .line-circle.Q { background-color: #FCCC0A; color: #000; }
    .line-circle.S { background-color: #808183; }

    .times {
      display: flex;
      align-items: baseline;
      gap: 24px;
      font-size: 32px;
      font-weight: 500;
      color: #333;
    }

    .times.empty {
      font-size: 20px;
      color: #aaa;
      font-weight: 400;
    }

    .time-item {
      min-width: 50px;
    }

    .time-unit {
      color: #888;
      font-weight: 400;
      font-size: 20px;
    }

    .updated {
      margin-top: 32px;
      text-align: center;
      font-size: 14px;
      color: #aaa;
      letter-spacing: 1px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #888;
      font-size: 18px;
    }

    .error {
      text-align: center;
      padding: 20px;
      color: #c00;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="card">
    <div id="content" class="loading">Loading train times...</div>
  </div>

  <!-- Load protobuf.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/protobufjs@7.2.5/dist/protobuf.min.js"></script>
  
  <script>
    // ============================================
    // CONFIGURATION
    // ============================================
    
    // Prospect Park station stop IDs
    // N = Manhattan-bound (northbound), S = Brooklyn-bound (southbound)
    const STOP_IDS = {
      // B/Q trains (Brighton Line)
      BQ_NORTH: 'D26N',  // Manhattan-bound
      BQ_SOUTH: 'D26S',  // Brooklyn-bound
      // Franklin Ave Shuttle
      S_NORTH: 'S04N',   // Toward Franklin Ave / Botanic Garden
      S_SOUTH: 'S04S'    // This is the southern terminus, so less relevant
    };

    // MTA Feed URLs (no API key required!)
    const FEED_URLS = {
      BDFM: 'https://api-endpoint.mta.info/Dataservice/mtagtfsfeeds/nyct%2Fgtfs-bdfm',
      // The Franklin Ave Shuttle (S) might be in a different feed
      // Try BDFM first, if not there, it might be in one of these:
      // ACE: 'https://api-endpoint.mta.info/Dataservice/mtagtfsfeeds/nyct%2Fgtfs-ace',
      // G: 'https://api-endpoint.mta.info/Dataservice/mtagtfsfeeds/nyct%2Fgtfs-g',
    };

    // How often to refresh (milliseconds)
    const REFRESH_INTERVAL = 30000; // 30 seconds

    // ============================================
    // GTFS-RT PROTOBUF SCHEMA
    // ============================================
    
    // Simplified GTFS-realtime schema for parsing MTA feeds
    const GTFS_RT_PROTO = `
      syntax = "proto2";
      package transit_realtime;

      message FeedMessage {
        required FeedHeader header = 1;
        repeated FeedEntity entity = 2;
      }

      message FeedHeader {
        required string gtfs_realtime_version = 1;
        optional uint64 timestamp = 2;
      }

      message FeedEntity {
        required string id = 1;
        optional TripUpdate trip_update = 3;
        optional VehiclePosition vehicle = 4;
        optional Alert alert = 5;
      }

      message TripUpdate {
        optional TripDescriptor trip = 1;
        repeated StopTimeUpdate stop_time_update = 2;
      }

      message TripDescriptor {
        optional string trip_id = 1;
        optional string route_id = 5;
        optional string start_time = 2;
        optional string start_date = 3;
      }

      message StopTimeUpdate {
        optional uint32 stop_sequence = 1;
        optional string stop_id = 4;
        optional StopTimeEvent arrival = 2;
        optional StopTimeEvent departure = 3;
      }

      message StopTimeEvent {
        optional int64 time = 2;
        optional int32 delay = 1;
        optional int32 uncertainty = 3;
      }

      message VehiclePosition {
        optional TripDescriptor trip = 1;
        optional Position position = 2;
        optional string stop_id = 7;
      }

      message Position {
        optional float latitude = 1;
        optional float longitude = 2;
      }

      message Alert {
        repeated EntitySelector informed_entity = 5;
      }

      message EntitySelector {
        optional string agency_id = 1;
        optional string route_id = 2;
        optional string stop_id = 6;
      }
    `;

    // ============================================
    // MAIN APP
    // ============================================

    let FeedMessage = null;

    async function init() {
      try {
        // Parse the protobuf schema
        const root = protobuf.parse(GTFS_RT_PROTO).root;
        FeedMessage = root.lookupType('transit_realtime.FeedMessage');
        
        // Initial fetch
        await updateDisplay();
        
        // Set up auto-refresh
        setInterval(updateDisplay, REFRESH_INTERVAL);
      } catch (err) {
        showError('Failed to initialize: ' + err.message);
      }
    }

    async function fetchFeed(url) {
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      const buffer = await response.arrayBuffer();
      return FeedMessage.decode(new Uint8Array(buffer));
    }

    function getArrivalsForStop(feed, stopId, routeFilter = null) {
      const now = Date.now();
      const arrivals = [];

      for (const entity of feed.entity) {
        if (!entity.tripUpdate) continue;
        
        const routeId = entity.tripUpdate.trip?.routeId;
        if (routeFilter && !routeFilter.includes(routeId)) continue;

        for (const stopTimeUpdate of entity.tripUpdate.stopTimeUpdate || []) {
          if (stopTimeUpdate.stopId !== stopId) continue;
          
          const arrivalTime = stopTimeUpdate.arrival?.time;
          if (!arrivalTime) continue;

          // Convert to milliseconds and calculate minutes until arrival
          const arrivalMs = Number(arrivalTime) * 1000;
          const minutesUntil = Math.round((arrivalMs - now) / 60000);

          if (minutesUntil >= 0 && minutesUntil < 60) {
            arrivals.push({
              route: routeId,
              minutes: minutesUntil
            });
          }
        }
      }

      // Sort by arrival time
      arrivals.sort((a, b) => a.minutes - b.minutes);
      return arrivals;
    }

    async function updateDisplay() {
      try {
        // Fetch the BDFM feed (contains B and Q)
        const feed = await fetchFeed(FEED_URLS.BDFM);

        // Get arrivals for each direction
        const manhattanArrivals = getArrivalsForStop(feed, STOP_IDS.BQ_NORTH);
        const brooklynArrivals = getArrivalsForStop(feed, STOP_IDS.BQ_SOUTH);
        
        // Try to get Franklin Ave Shuttle from the same feed first
        // Note: You may need to adjust the stop ID or use a different feed
        const franklinArrivals = getArrivalsForStop(feed, STOP_IDS.S_NORTH, ['FS']);

        // Group by route
        const data = {
          manhattan: {
            B: manhattanArrivals.filter(a => a.route === 'B').map(a => a.minutes).slice(0, 3),
            Q: manhattanArrivals.filter(a => a.route === 'Q').map(a => a.minutes).slice(0, 3)
          },
          brooklyn: {
            B: brooklynArrivals.filter(a => a.route === 'B').map(a => a.minutes).slice(0, 3),
            Q: brooklynArrivals.filter(a => a.route === 'Q').map(a => a.minutes).slice(0, 3)
          },
          franklin: {
            S: franklinArrivals.map(a => a.minutes).slice(0, 3)
          }
        };

        renderDisplay(data);
      } catch (err) {
        console.error('Error fetching feed:', err);
        showError('Failed to fetch train times. Retrying...');
      }
    }

    function renderTimes(times) {
      if (!times || times.length === 0) {
        return '<span class="times empty">No trains scheduled</span>';
      }
      return times
        .map(t => `<span class="time-item">${t} <span class="time-unit">min</span></span>`)
        .join('');
    }

    function renderDisplay(data) {
      const html = `
        <!-- Manhattan Section -->
        <div class="section-header">Manhattan</div>
        <div class="train-row">
          <div class="line-circle B">B</div>
          <div class="times">${renderTimes(data.manhattan.B)}</div>
        </div>
        <div class="train-row">
          <div class="line-circle Q">Q</div>
          <div class="times">${renderTimes(data.manhattan.Q)}</div>
        </div>

        <div class="divider"></div>

        <!-- Brooklyn Section -->
        <div class="section-header">Brooklyn</div>
        <div class="train-row">
          <div class="line-circle B">B</div>
          <div class="times">${renderTimes(data.brooklyn.B)}</div>
        </div>
        <div class="train-row">
          <div class="line-circle Q">Q</div>
          <div class="times">${renderTimes(data.brooklyn.Q)}</div>
        </div>

        <div class="divider"></div>

        <!-- Franklin Ave Section -->
        <div class="section-header">Franklin Ave</div>
        <div class="train-row">
          <div class="line-circle S">S</div>
          <div class="times">${renderTimes(data.franklin.S)}</div>
        </div>

        <!-- Last Updated -->
        <div class="updated">Updated ${new Date().toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })}</div>
      `;
      
      document.getElementById('content').innerHTML = html;
    }

    function showError(message) {
      const content = document.getElementById('content');
      // Keep existing display if we have one, just add error message
      if (!content.classList.contains('loading')) {
        const existingError = content.querySelector('.error');
        if (existingError) {
          existingError.textContent = message;
        } else {
          content.insertAdjacentHTML('beforeend', `<div class="error">${message}</div>`);
        }
      } else {
        content.innerHTML = `<div class="error">${message}</div>`;
      }
    }

    // Start the app
    init();
  </script>
</body>
</html>
