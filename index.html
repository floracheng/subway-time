<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta property="og:title" content="Prospect Park Subway">
  <meta property="og:description" content="Real-time B, Q, S train arrivals">
  <meta property="og:image" content="https://subway-time.netlify.app/og-image.png">
  <meta property="og:url" content="https://subway-time.netlify.app/">
  <meta property="og:type" content="website">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="icon" type="image/svg+xml" href="mta-icon.svg">
  <link rel="icon" type="image/png" href="mta-icon.png">
  <link rel="apple-touch-icon" href="mta-icon.png">
  <title>Prospect Park</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      -webkit-text-size-adjust: 100%;
    }

    body {
      min-height: 100vh;
      background-color: #fafafa;
      padding: 2vh 2vw;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card {
      width: 100%;
      height: 100%;
      background-color: #fff;
      border-radius: 2vw;
      padding: 3vh 3vw;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .title {
      font-size: 2vw;
      font-weight: 500;
      color: #aaa;
      text-transform: uppercase;
      letter-spacing: 0.3vw;
      padding-bottom: 2vh;
      margin-bottom: 2vh;
      border-bottom: 1px solid #eee;
    }

    .row {
      display: none;
      align-items: center;
      padding: 3vh 0;
      border-bottom: 2px solid #eee;
    }

    .row:last-of-type {
      border-bottom: none;
    }

    .row.visible {
      display: flex;
    }

    .direction {
      font-size: 2.5vw;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.2vw;
      width: 16vw;
      margin-right: 3vw;
      flex-shrink: 0;
    }

    .arrivals {
      display: flex;
      align-items: center;
      flex: 1;
    }

    .arrival {
      display: flex;
      align-items: center;
      gap: 1vw;
      width: 23vw;
    }

    .line-badge {
      width: 7vw;
      height: 7vw;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4vw;
      font-weight: bold;
      color: #fff;
      flex-shrink: 0;
    }

    .line-badge.B { background-color: #FF6319; }
    .line-badge.Q { background-color: #FCCC0A; color: #000; }
    .line-badge.S { background-color: #808183; }

    .time {
      font-size: 8vw;
      font-weight: 600;
      color: #222;
    }

    .updated {
      margin-top: 2vh;
      text-align: center;
      font-size: 1.5vw;
      color: #999;
    }

    .loading {
      text-align: center;
      padding: 10vh;
      color: #888;
      font-size: 3vw;
    }

    .error {
      text-align: center;
      padding: 5vh;
      color: #c00;
      font-size: 2vw;
    }

    /* Portrait mode for phones */
    @media (max-width: 500px) and (orientation: portrait) {
      html, body {
        overflow: hidden;
        height: 100vh;
      }

      body {
        padding: 3vh 4vw 12vh;
      }

      .card {
        padding: 4vh 5vw;
      }

      .title {
        font-size: 5vw;
        letter-spacing: 0.5vw;
        padding-bottom: 2vh;
        margin-bottom: 3vh;
      }

      .row {
        flex-direction: column;
        align-items: flex-start;
        padding: 3vh 0;
      }

      .direction {
        font-size: 5vw;
        width: auto;
        margin-right: 0;
        margin-bottom: 2vh;
      }

      .arrivals {
        width: 100%;
        justify-content: flex-start;
      }

      .arrival {
        width: 27vw;
        gap: 2vw;
      }

      .line-badge {
        width: 10vw;
        height: 10vw;
        font-size: 6vw;
      }

      .time {
        font-size: 11vw;
      }

      .updated {
        font-size: 4vw;
        margin-top: 3vh;
      }

      .loading {
        font-size: 6vw;
      }

      .error {
        font-size: 5vw;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <div id="loading" class="loading">Loading...</div>

    <h1 class="title">Prospect Park</h1>

    <div id="content" style="display: none;">
      <div class="row" id="row-manhattan">
        <div class="direction">Manhattan</div>
        <div class="arrivals" id="arrivals-manhattan"></div>
      </div>

      <div class="row" id="row-brooklyn">
        <div class="direction">Brooklyn</div>
        <div class="arrivals" id="arrivals-brooklyn"></div>
      </div>

      <div class="row" id="row-franklin">
        <div class="direction">Franklin Ave</div>
        <div class="arrivals" id="arrivals-franklin"></div>
      </div>

      <div class="updated" id="updated"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/protobufjs@7.2.5/dist/protobuf.min.js"></script>
  <script src="./stops.js"></script>

  <script>
    // Extract base station ID without N/S suffix
    function getStopBase(stopId) {
      if (!stopId) return null;
      const lastChar = stopId.slice(-1).toUpperCase();
      if (lastChar === 'N' || lastChar === 'S') {
        return stopId.slice(0, -1);
      }
      return stopId;
    }

    // Parse station from URL param, default to Prospect Park (D26)
    function parseStationParam() {
      const params = new URLSearchParams(window.location.search);
      const station = params.get('station');

      if (!station) {
        return {
          stopIds: { NORTHBOUND: 'D26N', SOUTHBOUND: 'D26S' },
          lines: null  // Default: use hardcoded line filters
        };
      }

      // Split station:lines format (e.g., "D27:B;Q" or "D27N:B;Q")
      const [stationId, linesStr] = station.split(':');
      const lines = linesStr ? linesStr.split(';').map(l => l.trim().toUpperCase()) : null;

      // Check if station already has direction suffix
      const lastChar = stationId.slice(-1).toUpperCase();
      let stopIds;
      if (lastChar === 'N') {
        stopIds = { NORTHBOUND: stationId.toUpperCase(), SOUTHBOUND: null };
      } else if (lastChar === 'S') {
        stopIds = { NORTHBOUND: null, SOUTHBOUND: stationId.toUpperCase() };
      } else {
        // No direction suffix - use both
        const base = stationId.toUpperCase();
        stopIds = { NORTHBOUND: base + 'N', SOUTHBOUND: base + 'S' };
      }

      return { stopIds, lines };
    }

    const { stopIds: STOP_IDS, lines: LINE_FILTER } = parseStationParam();

    // Update page title and header with station name
    const baseId = getStopBase(STOP_IDS.NORTHBOUND || STOP_IDS.SOUTHBOUND);
    const stationName = window.stops?.[baseId] || 'Subway';
    document.title = stationName;
    document.querySelector('.title').textContent = stationName;
    document.querySelector('meta[property="og:title"]').content = stationName + ' Subway';

    const FEED_URLS = {
      BDFM: 'https://api-endpoint.mta.info/Dataservice/mtagtfsfeeds/nyct%2Fgtfs-bdfm',
      NQRW: 'https://api-endpoint.mta.info/Dataservice/mtagtfsfeeds/nyct%2Fgtfs-nqrw'
    };

    const REFRESH_INTERVAL = 30000;

    const GTFS_RT_PROTO = `
      syntax = "proto2";
      package transit_realtime;
      message FeedMessage {
        required FeedHeader header = 1;
        repeated FeedEntity entity = 2;
      }
      message FeedHeader {
        required string gtfs_realtime_version = 1;
        optional uint64 timestamp = 2;
      }
      message FeedEntity {
        required string id = 1;
        optional TripUpdate trip_update = 3;
      }
      message TripUpdate {
        optional TripDescriptor trip = 1;
        repeated StopTimeUpdate stop_time_update = 2;
      }
      message TripDescriptor {
        optional string trip_id = 1;
        optional string route_id = 5;
      }
      message StopTimeUpdate {
        optional string stop_id = 4;
        optional StopTimeEvent arrival = 2;
      }
      message StopTimeEvent {
        optional int64 time = 2;
      }
    `;

    let FeedMessage = null;

    async function init() {
      try {
        const root = protobuf.parse(GTFS_RT_PROTO).root;
        FeedMessage = root.lookupType('transit_realtime.FeedMessage');
        await updateDisplay();
        setInterval(updateDisplay, REFRESH_INTERVAL);
        document.addEventListener('visibilitychange', () => {
          if (document.visibilityState === 'visible') updateDisplay();
        });
      } catch (err) {
        showError('Failed to initialize: ' + err.message);
      }
    }

    async function fetchFeed(url) {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const buffer = await response.arrayBuffer();
      return FeedMessage.decode(new Uint8Array(buffer));
    }

    function getArrivalsFromFeed(feed, stopId, routeFilter) {
      const now = Date.now();
      const arrivals = [];
      for (const entity of feed.entity) {
        if (!entity.tripUpdate) continue;
        const routeId = entity.tripUpdate.trip?.routeId;
        if (!routeFilter.includes(routeId)) continue;
        for (const stu of entity.tripUpdate.stopTimeUpdate || []) {
          if (stu.stopId !== stopId) continue;
          const arrivalTime = stu.arrival?.time;
          if (!arrivalTime) continue;
          const arrivalMs = Number(arrivalTime) * 1000;
          const minutes = Math.floor((arrivalMs - now) / 60000);
          if (minutes >= 0 && minutes < 90) {
            arrivals.push({ route: routeId === 'FS' ? 'S' : routeId, minutes });
          }
        }
      }
      return arrivals;
    }

    async function updateDisplay() {
      try {
        const [bdfmFeed, nqrwFeed] = await Promise.all([
          fetchFeed(FEED_URLS.BDFM),
          fetchFeed(FEED_URLS.NQRW)
        ]);

        // Determine which routes to query (default to Prospect Park's B, Q, S)
        const routeFilter = LINE_FILTER || ['B', 'Q', 'FS'];

        const bdfmNorth = STOP_IDS.NORTHBOUND ? getArrivalsFromFeed(bdfmFeed, STOP_IDS.NORTHBOUND, routeFilter) : [];
        const bdfmSouth = STOP_IDS.SOUTHBOUND ? getArrivalsFromFeed(bdfmFeed, STOP_IDS.SOUTHBOUND, routeFilter) : [];
        const nqrwNorth = STOP_IDS.NORTHBOUND ? getArrivalsFromFeed(nqrwFeed, STOP_IDS.NORTHBOUND, routeFilter) : [];
        const nqrwSouth = STOP_IDS.SOUTHBOUND ? getArrivalsFromFeed(nqrwFeed, STOP_IDS.SOUTHBOUND, routeFilter) : [];

        // Combine all arrivals per direction, sorted by time
        const manhattan = [...bdfmNorth, ...nqrwNorth]
          .filter(a => a.route !== 'S')
          .sort((a, b) => a.minutes - b.minutes).slice(0, 3);
        const brooklyn = [...bdfmSouth, ...nqrwSouth]
          .filter(a => a.route !== 'S')
          .sort((a, b) => a.minutes - b.minutes).slice(0, 3);
        const franklin = [...bdfmNorth, ...nqrwNorth]
          .filter(a => a.route === 'S')
          .sort((a, b) => a.minutes - b.minutes).slice(0, 3);

        renderDisplay({ manhattan, brooklyn, franklin });
      } catch (err) {
        console.error('Error fetching feed:', err);
        showError('Failed to fetch train times. Retrying...');
      }
    }

    function renderRow(rowId, arrivalsId, arrivals) {
      const row = document.getElementById(rowId);
      const container = document.getElementById(arrivalsId);

      if (!arrivals || arrivals.length === 0) {
        row.classList.remove('visible');
        return;
      }

      row.classList.add('visible');
      container.innerHTML = arrivals.map(a => `
        <div class="arrival">
          <div class="line-badge ${a.route}">${a.route}</div>
          <div class="time">${a.minutes}</div>
        </div>
      `).join('');
    }

    function renderDisplay(data) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'block';

      renderRow('row-manhattan', 'arrivals-manhattan', data.manhattan);
      renderRow('row-brooklyn', 'arrivals-brooklyn', data.brooklyn);
      renderRow('row-franklin', 'arrivals-franklin', data.franklin);

      document.getElementById('updated').textContent =
        `Updated ${new Date().toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })}`;
    }

    function showError(message) {
      const loading = document.getElementById('loading');
      const content = document.getElementById('content');
      if (content.style.display === 'block') {
        console.error(message);
      } else {
        loading.innerHTML = `<div class="error">${message}</div>`;
      }
    }

    init();
  </script>

  <script data-goatcounter="https://floracheng.goatcounter.com/count"
          async src="//gc.zgo.at/count.js"></script>
</body>
</html>
