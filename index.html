<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta property="og:title" content="Prospect Park Subway">
  <meta property="og:description" content="Real-time B, Q, S train arrivals">
  <meta property="og:image" content="https://subway-time.netlify.app/og-image.png">
  <meta property="og:url" content="https://subway-time.netlify.app/">
  <meta property="og:type" content="website">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="icon" type="image/svg+xml" href="mta-icon.svg">
  <link rel="icon" type="image/png" href="mta-icon.png">
  <link rel="apple-touch-icon" href="mta-icon.png">
  <title>Prospect Park</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      -webkit-text-size-adjust: 100%;
    }

    body {
      min-height: 100vh;
      background-color: #fafafa;
      padding: 2vh 2vw;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    #cards-container {
      display: flex;
      flex-direction: column;
      gap: 2vh;
      max-width: 1200px;
      margin: 0 auto;
    }

    .card {
      width: 100%;
      background-color: #fff;
      border-radius: 2vw;
      padding: 3vh 3vw;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .title {
      font-size: 2vw;
      font-weight: 500;
      color: #aaa;
      text-transform: uppercase;
      letter-spacing: 0.3vw;
      padding-bottom: 2vh;
      margin-bottom: 2vh;
      border-bottom: 1px solid #eee;
    }

    .row {
      display: none;
      align-items: center;
      padding: 3vh 0;
      border-bottom: 2px solid #eee;
    }

    .row:last-of-type {
      border-bottom: none;
    }

    .row.visible {
      display: flex;
    }

    .direction {
      font-size: 2.5vw;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.2vw;
      width: 16vw;
      margin-right: 3vw;
      flex-shrink: 0;
    }

    .arrivals {
      display: flex;
      align-items: center;
      flex: 1;
    }

    .arrival {
      display: flex;
      align-items: center;
      gap: 1vw;
      width: 23vw;
    }

    .line-badge {
      width: 7vw;
      height: 7vw;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4vw;
      font-weight: bold;
      color: #fff;
      flex-shrink: 0;
    }

    /* 1, 2, 3 - Red */
    .line-badge.\31 { background-color: #EE352E; }
    .line-badge.\32 { background-color: #EE352E; }
    .line-badge.\33 { background-color: #EE352E; }

    /* 4, 5, 6 - Green */
    .line-badge.\34 { background-color: #00933C; }
    .line-badge.\35 { background-color: #00933C; }
    .line-badge.\36 { background-color: #00933C; }

    /* 7 - Purple */
    .line-badge.\37 { background-color: #B933AD; }

    /* A, C, E - Blue */
    .line-badge.A { background-color: #0039A6; }
    .line-badge.C { background-color: #0039A6; }
    .line-badge.E { background-color: #0039A6; }

    /* B, D, F, M - Orange */
    .line-badge.B { background-color: #FF6319; }
    .line-badge.D { background-color: #FF6319; }
    .line-badge.F { background-color: #FF6319; }
    .line-badge.M { background-color: #FF6319; }

    /* G - Lime Green */
    .line-badge.G { background-color: #6CBE45; }

    /* J, Z - Brown */
    .line-badge.J { background-color: #996633; }
    .line-badge.Z { background-color: #996633; }

    /* L - Gray */
    .line-badge.L { background-color: #A7A9AC; }

    /* N, Q, R, W - Yellow */
    .line-badge.N { background-color: #FCCC0A; color: #000; }
    .line-badge.Q { background-color: #FCCC0A; color: #000; }
    .line-badge.R { background-color: #FCCC0A; color: #000; }
    .line-badge.W { background-color: #FCCC0A; color: #000; }

    /* S - Gray (Shuttles) */
    .line-badge.S { background-color: #808183; }

    /* SI - Blue (Staten Island Railway) */
    .line-badge.SI { background-color: #0039A6; }

    .time {
      font-size: 8vw;
      font-weight: 600;
      color: #222;
    }

    .updated {
      margin-top: 2vh;
      text-align: center;
      font-size: 1.5vw;
      color: #999;
    }

    .loading {
      text-align: center;
      padding: 10vh;
      color: #888;
      font-size: 3vw;
    }

    .error {
      text-align: center;
      padding: 5vh;
      color: #c00;
      font-size: 2vw;
    }

    /* Portrait mode for phones */
    @media (max-width: 500px) and (orientation: portrait) {
      body {
        padding: 3vh 4vw 12vh;
      }

      #cards-container {
        gap: 3vh;
      }

      .card {
        padding: 4vh 5vw;
      }

      .title {
        font-size: 5vw;
        letter-spacing: 0.5vw;
        padding-bottom: 2vh;
        margin-bottom: 3vh;
      }

      .row {
        flex-direction: column;
        align-items: flex-start;
        padding: 3vh 0;
      }

      .direction {
        font-size: 5vw;
        width: auto;
        margin-right: 0;
        margin-bottom: 2vh;
      }

      .arrivals {
        width: 100%;
        justify-content: flex-start;
      }

      .arrival {
        width: 27vw;
        gap: 2vw;
      }

      .line-badge {
        width: 10vw;
        height: 10vw;
        font-size: 6vw;
      }

      .time {
        font-size: 11vw;
      }

      .updated {
        font-size: 4vw;
        margin-top: 3vh;
      }

      .loading {
        font-size: 6vw;
      }

      .error {
        font-size: 5vw;
      }
    }
  </style>
</head>
<body>
  <div id="cards-container"></div>

  <script src="https://cdn.jsdelivr.net/npm/protobufjs@7.2.5/dist/protobuf.min.js"></script>
  <script src="./stops.js"></script>

  <script>
    // Extract base station ID without N/S suffix
    function getStopBase(stopId) {
      if (!stopId) return null;
      const lastChar = stopId.slice(-1).toUpperCase();
      if (lastChar === 'N' || lastChar === 'S') {
        return stopId.slice(0, -1);
      }
      return stopId;
    }

    // Parse a single station string (e.g., "D27:B;Q" or "D27N:B;Q")
    function parseStation(stationStr) {
      const [stationId, linesStr] = stationStr.split(':');
      const lines = linesStr ? linesStr.split(';').map(l => l.trim().toUpperCase()) : null;

      // Check if station already has direction suffix
      const lastChar = stationId.slice(-1).toUpperCase();
      let stopIds;
      if (lastChar === 'N') {
        stopIds = { NORTHBOUND: stationId.toUpperCase(), SOUTHBOUND: null };
      } else if (lastChar === 'S') {
        stopIds = { NORTHBOUND: null, SOUTHBOUND: stationId.toUpperCase() };
      } else {
        // No direction suffix - use both
        const base = stationId.toUpperCase();
        stopIds = { NORTHBOUND: base + 'N', SOUTHBOUND: base + 'S' };
      }

      const baseId = getStopBase(stopIds.NORTHBOUND || stopIds.SOUTHBOUND);
      const stationName = window.stops?.[baseId] || 'Subway';

      return { stopIds, lines, stationName, baseId };
    }

    // Parse station param (supports multiple comma-separated stations)
    function parseStationParam() {
      const params = new URLSearchParams(window.location.search);
      const station = params.get('station');

      if (!station) {
        return [parseStation('D26')];
      }

      return station.split(',').map(s => parseStation(s.trim()));
    }

    const STATIONS = parseStationParam();

    // Update page title with first station name
    document.title = STATIONS[0].stationName;
    document.querySelector('meta[property="og:title"]').content = STATIONS[0].stationName + ' Subway';

    const FEED_URLS = {
      '123456': 'https://api-endpoint.mta.info/Dataservice/mtagtfsfeeds/nyct%2Fgtfs',
      ACE: 'https://api-endpoint.mta.info/Dataservice/mtagtfsfeeds/nyct%2Fgtfs-ace',
      BDFM: 'https://api-endpoint.mta.info/Dataservice/mtagtfsfeeds/nyct%2Fgtfs-bdfm',
      G: 'https://api-endpoint.mta.info/Dataservice/mtagtfsfeeds/nyct%2Fgtfs-g',
      JZ: 'https://api-endpoint.mta.info/Dataservice/mtagtfsfeeds/nyct%2Fgtfs-jz',
      L: 'https://api-endpoint.mta.info/Dataservice/mtagtfsfeeds/nyct%2Fgtfs-l',
      NQRW: 'https://api-endpoint.mta.info/Dataservice/mtagtfsfeeds/nyct%2Fgtfs-nqrw',
      SI: 'https://api-endpoint.mta.info/Dataservice/mtagtfsfeeds/nyct%2Fgtfs-si'
    };

    const REFRESH_INTERVAL = 30000;

    const GTFS_RT_PROTO = `
      syntax = "proto2";
      package transit_realtime;
      message FeedMessage {
        required FeedHeader header = 1;
        repeated FeedEntity entity = 2;
      }
      message FeedHeader {
        required string gtfs_realtime_version = 1;
        optional uint64 timestamp = 2;
      }
      message FeedEntity {
        required string id = 1;
        optional TripUpdate trip_update = 3;
      }
      message TripUpdate {
        optional TripDescriptor trip = 1;
        repeated StopTimeUpdate stop_time_update = 2;
      }
      message TripDescriptor {
        optional string trip_id = 1;
        optional string route_id = 5;
      }
      message StopTimeUpdate {
        optional string stop_id = 4;
        optional StopTimeEvent arrival = 2;
      }
      message StopTimeEvent {
        optional int64 time = 2;
      }
    `;

    let FeedMessage = null;

    // Create HTML for a station card
    function createStationCard(station, index) {
      return `
        <div class="card" id="card-${index}">
          <h1 class="title">${station.stationName}</h1>
          <div class="content" id="content-${index}" style="display: none;">
            <div class="row" id="row-${index}-manhattan">
              <div class="direction">Manhattan</div>
              <div class="arrivals" id="arrivals-${index}-manhattan"></div>
            </div>
            <div class="row" id="row-${index}-brooklyn">
              <div class="direction">Brooklyn</div>
              <div class="arrivals" id="arrivals-${index}-brooklyn"></div>
            </div>
            <div class="row" id="row-${index}-franklin">
              <div class="direction">Franklin Ave</div>
              <div class="arrivals" id="arrivals-${index}-franklin"></div>
            </div>
            <div class="updated" id="updated-${index}"></div>
          </div>
          <div id="loading-${index}" class="loading">Loading...</div>
        </div>
      `;
    }

    async function init() {
      try {
        const root = protobuf.parse(GTFS_RT_PROTO).root;
        FeedMessage = root.lookupType('transit_realtime.FeedMessage');

        // Create cards for all stations
        const container = document.getElementById('cards-container');
        container.innerHTML = STATIONS.map((station, i) => createStationCard(station, i)).join('');

        await updateDisplay();
        setInterval(updateDisplay, REFRESH_INTERVAL);
        document.addEventListener('visibilitychange', () => {
          if (document.visibilityState === 'visible') updateDisplay();
        });
      } catch (err) {
        console.error('Failed to initialize:', err.message);
      }
    }

    async function fetchFeed(url) {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const buffer = await response.arrayBuffer();
      return FeedMessage.decode(new Uint8Array(buffer));
    }

    function getArrivalsFromFeed(feed, stopId, routeFilter) {
      const now = Date.now();
      const arrivals = [];
      for (const entity of feed.entity) {
        if (!entity.tripUpdate) continue;
        const routeId = entity.tripUpdate.trip?.routeId;
        if (routeFilter && !routeFilter.includes(routeId)) continue;
        for (const stu of entity.tripUpdate.stopTimeUpdate || []) {
          if (stu.stopId !== stopId) continue;
          const arrivalTime = stu.arrival?.time;
          if (!arrivalTime) continue;
          const arrivalMs = Number(arrivalTime) * 1000;
          const minutes = Math.floor((arrivalMs - now) / 60000);
          if (minutes >= 0 && minutes < 90) {
            arrivals.push({ route: routeId === 'FS' ? 'S' : routeId, minutes });
          }
        }
      }
      return arrivals;
    }

    async function updateDisplay() {
      try {
        // Fetch all feeds in parallel
        const feeds = await Promise.all(
          Object.values(FEED_URLS).map(url => fetchFeed(url))
        );

        // Update each station
        STATIONS.forEach((station, index) => {
          updateStation(station, index, feeds);
        });
      } catch (err) {
        console.error('Error fetching feed:', err);
      }
    }

    function updateStation(station, index, feeds) {
      const { stopIds, lines } = station;
      const routeFilter = lines || null;

      // Get arrivals from all feeds for both directions
      const northArrivals = [];
      const southArrivals = [];

      feeds.forEach(feed => {
        if (stopIds.NORTHBOUND) {
          northArrivals.push(...getArrivalsFromFeed(feed, stopIds.NORTHBOUND, routeFilter));
        }
        if (stopIds.SOUTHBOUND) {
          southArrivals.push(...getArrivalsFromFeed(feed, stopIds.SOUTHBOUND, routeFilter));
        }
      });

      // Combine all arrivals per direction, sorted by time
      const manhattan = northArrivals
        .filter(a => a.route !== 'S')
        .sort((a, b) => a.minutes - b.minutes).slice(0, 3);
      const brooklyn = southArrivals
        .filter(a => a.route !== 'S')
        .sort((a, b) => a.minutes - b.minutes).slice(0, 3);
      const franklin = northArrivals
        .filter(a => a.route === 'S')
        .sort((a, b) => a.minutes - b.minutes).slice(0, 3);

      renderStation(index, { manhattan, brooklyn, franklin });
    }

    function renderRow(rowId, arrivalsId, arrivals) {
      const row = document.getElementById(rowId);
      const container = document.getElementById(arrivalsId);

      if (!arrivals || arrivals.length === 0) {
        row.classList.remove('visible');
        return;
      }

      row.classList.add('visible');
      container.innerHTML = arrivals.map(a => `
        <div class="arrival">
          <div class="line-badge ${a.route}">${a.route}</div>
          <div class="time">${a.minutes}</div>
        </div>
      `).join('');
    }

    function renderStation(index, data) {
      document.getElementById(`loading-${index}`).style.display = 'none';
      document.getElementById(`content-${index}`).style.display = 'block';

      renderRow(`row-${index}-manhattan`, `arrivals-${index}-manhattan`, data.manhattan);
      renderRow(`row-${index}-brooklyn`, `arrivals-${index}-brooklyn`, data.brooklyn);
      renderRow(`row-${index}-franklin`, `arrivals-${index}-franklin`, data.franklin);

      document.getElementById(`updated-${index}`).textContent =
        `Updated ${new Date().toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })}`;
    }

    init();
  </script>

  <script data-goatcounter="https://floracheng.goatcounter.com/count"
          async src="//gc.zgo.at/count.js"></script>
</body>
</html>
